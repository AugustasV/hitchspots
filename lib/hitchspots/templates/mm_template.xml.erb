<%
def color(rating)
  case rating
  when "1", "2" then "#placemark-green"
  when "3"      then "#placemark-yellow"
  when "4"      then "#placemark-orange"
  else               "#placemark-red"
  end
end
def hitchability(rating)
  case rating
  when "1" then "Very Good"
  when "2" then "Good"
  when "3" then "Medium"
  when "4" then "Bad"
  when "5" then "Very Bad"
  else          "Unknown"
  end
end
%>
<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://earth.google.com/kml/2.2">
<Document>
  <Style id="placemark-green">
    <IconStyle>
      <Icon>
        <href>http://mapswith.me/placemarks/placemark-green.png</href>
      </Icon>
    </IconStyle>
  </Style>
  <Style id="placemark-orange">
    <IconStyle>
      <Icon>
        <href>http://mapswith.me/placemarks/placemark-orange.png</href>
      </Icon>
    </IconStyle>
  </Style>
  <Style id="placemark-yellow">
    <IconStyle>
      <Icon>
        <href>http://mapswith.me/placemarks/placemark-yellow.png</href>
      </Icon>
    </IconStyle>
  </Style>
  <Style id="placemark-red">
    <IconStyle>
      <Icon>
        <href>http://mapswith.me/placemarks/placemark-red.png</href>
      </Icon>
    </IconStyle>
  </Style>
  <name>HitchSpots: <%= title %></name>
  <visibility>1</visibility>
  <% spots.each_with_index do |spot, i| %>
  <Placemark>
    <name><%= spot.fetch("location", {}).fetch("locality", nil) || "Spot #{spot['id']}" %></name>
    <description>Hitchability: <%= hitchability(spot["rating"]) %><% if spot.fetch("description", {}).fetch("en_UK", {}).fetch("description", nil) %>

<%= spot.fetch("description", {}).fetch("en_UK", {}).fetch("description", nil) %><% end %></description>
    <TimeStamp><when><%= time %></when></TimeStamp>
    <styleUrl><%= color(spot["rating"]) %></styleUrl>
    <Point><coordinates><%= spot["lon"] %>,<%= spot["lat"] %></coordinates></Point>
    <ExtendedData xmlns:mwm="http://mapswith.me">
      <mwm:scale>16</mwm:scale>
    </ExtendedData>
  </Placemark>
  <% end %>
</Document>
</kml>
